<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <meta name="color-scheme" content="dark light" />
  <title>DüèÄACH</title>
  <link rel="icon" href="/static/favicon.ico" />

  <!-- Core app/scripts (load each ONCE, keep order) -->
  <script src="/static/js/coachAssistant.js"></script>
  
  <!-- Slow-mo arbiter (listens for shot:release / shot:summary) -->
  <script src="/static/js/slowmo_arbiter.js"></script>

  <!-- Core libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>

  <!-- MediaPipe Pose Model (exposes FilesetResolver, PoseLandmarker globally) -->
  <script type="module">
    import {
      FilesetResolver,
      PoseLandmarker
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.mjs";
    window.FilesetResolver = FilesetResolver;
    window.PoseLandmarker = PoseLandmarker;
  </script>

  <!-- Styles -->
  <link rel="stylesheet" href="/static/style.css" />
  <!-- Boxicons -->
  <link
    href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
    rel="stylesheet"
  />
</head>

<body data-app="doach" data-build="2025-08-22">

  <!-- Prompt bar is fine -->
  <div id="promptBar"></div>

  <!-- ‚úÖ Main Video + Overlay (single overlayPrompt only) -->
  <div class="video-frame" id="videoFrame" style="position:relative">
    <video id="videoPlayer" playsinline muted></video>
    <canvas id="overlay"></canvas>

    <div class="session-status" role="status" aria-live="polite">
      SESSION IN PROGRESS...
    </div>

    <!-- keep just ONE prompt element with this id -->
    <div id="overlayPrompt"
         style="position:absolute; left:12px; top:12px; z-index:3;
                background:rgba(0,0,0,.6); color:#fff; padding:.4rem .6rem;
                border-radius:.5rem; font:600 13px/1.2 system-ui; display:none;">
      üìç Tap the hoop to begin setup
    </div>
  </div>

  <!-- Coach Feedback + Shot Summary (unchanged) -->
  <div id="coachNotes" style="
    position: absolute; top: 10px; left: 10px;
    max-width: 400px; background: rgba(0,0,0,0.7); color: #fff;
    padding: 12px 16px; border-radius: 8px;
    font-size: 14px; line-height: 1.4; z-index: 999;" aria-live="polite">
    <strong>ü§ñ Coach Feedback</strong><br />
    <span style="color:gray;">(No shot yet)</span>
  </div>

  <div id="shotOverlaySummary" style="
    position: absolute; bottom: 80px; right: 20px; padding: 10px 16px;
    background: rgba(0,0,0,0.75); color: white; border-radius: 10px;
    font-size: 14px; line-height: 1.4; opacity: 0; transition: opacity .4s ease;
    z-index: 20; pointer-events: none; display: none;"></div>

  <input type="file" id="videoInput" accept="video/*" hidden />

  <!-- Feedback widget -->
  <script type="module">
    import { installFeedbackWidget } from "/static/js/feedback_widget.js";
    window.addEventListener("DOMContentLoaded", () => installFeedbackWidget());
  </script>

  <!-- Page boot: guard against duplicate listeners, set globals, lock overlay -->
  <script>
    (function bootIndexOnce(){
      if (window.__indexBooted) return;
      window.__indexBooted = true;

      window.addEventListener("DOMContentLoaded", () => {
        const video   = document.getElementById("videoPlayer");
        const overlay = document.getElementById("overlay");
        const prompt  = document.getElementById("overlayPrompt");

        // expose for modules that expect these
        window.videoPlayer   = video;    // slowmo_arbiter uses this
        window.overlayCanvas = overlay;

        // prompt helpers
        window.showPrompt = (msg) => { if (prompt){ prompt.textContent = msg; prompt.style.display = "block"; } };
        window.hidePrompt = () => { if (prompt){ prompt.style.display = "none"; } };
        window.lockHoop   = () => { window.hidePrompt?.(); console.log("‚úÖ Hoop lock UI confirmed"); };

        // resize/lock overlay when metadata is ready
        video.addEventListener("loadedmetadata", () => {
          try { window.ensureOverlayCss?.(); window.lockOverlayToVideo?.(); } catch {}
        }, { once: true });

        // detector readiness (single watcher)
        (function waitReady(i=0){
          if (window.__detReady) { console.log("‚úÖ Local detector ready (worker)"); document.body.dataset.detector = "ready"; return; }
          if (i > 50)           { console.warn("Detector not ready yet");         document.body.dataset.detector = "pending"; return; }
          setTimeout(() => waitReady(i+1), 100);
        })();

        // reflect slow-mo state for quick visual checks
        window.addEventListener("shot:release", () => { document.body.setAttribute("data-slowmo", "on"); },  { passive:true });
        window.addEventListener("shot:summary", () => { document.body.setAttribute("data-slowmo", "off"); }, { passive:true });
      });
    })();

    // iOS native bridge (unchanged)
    function startNativeVoice(){ window.webkit?.messageHandlers?.doach?.postMessage({ action: "startVoice" }); }
    function stopNativeVoice(){  window.webkit?.messageHandlers?.doach?.postMessage({ action: "stopVoice"  }); }
  </script>

  <!-- UI menu -->
  <script src="/static/js/ui_menu.js?v=2"></script>

  <!-- App entry (imports modules like analyze_frame.js, etc.) -->
  <script type="module" src="/static/js/app.js?v=20250822"></script>
</body>

</html>
